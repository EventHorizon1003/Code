from __future__ import annotations

import json
from typing import Any, Dict, List, Optional

import certifi
import requests

# LangChain Core
from langchain_core.language_models.chat_models import BaseChatModel
from langchain_core.messages import (
    AIMessage,
    BaseMessage,
    HumanMessage,
    SystemMessage,
)
from langchain_core.outputs import ChatResult, ChatGeneration
from langchain_core.callbacks import (
    CallbackManagerForLLMRun,
    AsyncCallbackManagerForLLMRun,
)

# Tools + Agent
from langchain_core.tools import tool
from langchain.agents import create_agent


# =====================================================================
# 1. CUSTOM LLM (company website wrapper)
# =====================================================================

class CustomLLM(BaseChatModel):
    """
    Your company LLM wrapper:
        - login
        - send prompt
        - receive text
        - logout
    Does NOT support tools. Only pure text in/out.
    The Agent system handles tools locally in Python.
    """

    base_url: str
    username: str
    password: str
    model_name: str = "aide-gpt-4.1"

    @property
    def _llm_type(self) -> str:
        return "company_llm"

    # --------- SYNC GENERATE (model.invoke) ----------
    def _generate(
        self,
        messages: List[BaseMessage],
        stop: Optional[List[str]] = None,
        run_manager: Optional[CallbackManagerForLLMRun] = None,
        **kwargs
    ) -> ChatResult:

        login_url = f"{self.base_url}/api/login"
        chat_url = f"{self.base_url}/api/chat2"
        logout_url = f"{self.base_url}/api/logout"

        # Convert LangChain messages â†’ company-style
        http_messages = []
        for m in messages:
            if isinstance(m, HumanMessage):
                http_messages.append({"role": "user", "content": m.content})
            elif isinstance(m, SystemMessage):
                http_messages.append({"role": "system", "content": m.content})
            elif isinstance(m, AIMessage):
                http_messages.append({"role": "assistant", "content": m.content})
            else:
                http_messages.append({"role": "assistant", "content": m.content})

        # Last user message is "prompt" for website
        last_user_text = ""
        for msg in reversed(http_messages):
            if msg["role"] == "user":
                last_user_text = msg["content"]
                break

        payload = {
            "model": {
                "id": self.model_name,
                "name": "GPT-5",
                "desc": "",
                "maxLength": 96000,
                "tokenLimit": 16000,
                "endPointType": "openai",
                "tokenCounter": "gpt",
            },
            "messages": http_messages,
            "prompt": last_user_text,
            "key": "",
            "temperature": 0.3,
            "organic": True,
        }

        # ---- LOGIN â†’ CHAT â†’ LOGOUT ----
        with requests.Session() as s:
            login_resp = s.post(login_url, json={"username": self.username, "password": self.password}, verify=certifi.where())
            if login_resp.status_code != 200:
                return ChatResult(
                    generations=[ChatGeneration(message=AIMessage(content="Login failed."))]
                )

            chat_resp = s.post(chat_url, json=payload, verify=certifi.where())

            try:
                s.get(logout_url, verify=certifi.where())
            except:
                pass

        # -----------------------
        # Parse server response
        # -----------------------
        try:
            data = chat_resp.json()
        except:
            msg = chat_resp.text
            return ChatResult(generations=[ChatGeneration(message=AIMessage(content=msg))])

        # Adjust according to your API
        if isinstance(data, dict) and "choices" in data:
            content = data["choices"][0]["message"]["content"]
        elif isinstance(data, dict) and "text" in data:
            content = data["text"]
        else:
            content = json.dumps(data)

        msg = AIMessage(content=content)
        return ChatResult(generations=[ChatGeneration(message=msg)])

    # --------- ASYNC STUB REQUIRED ----------
    async def _agenerate(
        self,
        messages: List[BaseMessage],
        stop=None,
        run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
        **kwargs
    ) -> ChatResult:
        return self._generate(messages, stop=stop, **kwargs)


# =====================================================================
# 2. TOOL (runs locally in Python)
# =====================================================================

@tool
def test_time_saving(old_time_s: float, new_time_s: float) -> float:
    """
    Calculate time saving percentage.
    This function is executed LOCALLY, not via the company website.
    """
    print("\nðŸ”¥ TOOL EXECUTED: test_time_saving() ðŸ”¥")
    return (old_time_s - new_time_s) / old_time_s * 100.0


tools = [test_time_saving]


# =====================================================================
# 3. CREATE AGENT (LangChain 1.1)
# =====================================================================

def build_agent(llm: CustomLLM):
    system_prompt = (
        "You are an ATE test assistant.\n"
        "When calculation is needed, ALWAYS call the appropriate tool.\n"
        "Do not guess. Use the tool strictly.\n"
    )

    agent = create_agent(
        model=llm,
        tools=tools,
        system_prompt=system_prompt,
    )

    return agent


# =====================================================================
# 4. RUN THE AGENT
# =====================================================================

if __name__ == "__main__":
    # Replace with your real company LLM URL + login
    llm = CustomLLM(
        base_url="https://your-company-llm-host",
        username="your_username",
        password="your_password",
    )

    agent = build_agent(llm)

    # Correct input format for LangChain 1.1 agents
    result = agent.invoke({
        "messages": [
            {
                "role": "user",
                "content": (
                    "Old test time is 20 seconds. New test time is 12 seconds. "
                    "Use tools to compute the savings."
                )
            }
        ]
    })

    print("\n=== FINAL AGENT OUTPUT ===")
    print(result)